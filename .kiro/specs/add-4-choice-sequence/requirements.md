# Requirements Document

## Project Description (Input)

選択可能な数列に「4 択（A, B, C, D）」を追加する。クライアントのカード選択肢に新たに 4 択の選択肢セットを追加し、サーバー側でそのシーケンスを保持・配信できるようにする。

## Requirements

<!-- Generated by /kiro-spec-requirements -->

### Requirement 1: クライアント UI — 4 択カードの追加

**Objective:** As a ユーザー, I want 4 択の選択肢を選べるように, so that 見積もりで A/B/C/D を使える

#### Acceptance Criteria

1. When ユーザーが '4 択' の数列を選択したとき, the Client shall 四つの選択肢カード（A, B, C, D）を表示する。
2. When ユーザーがカード（A/B/C/D）のいずれかをクリックしたとき, the Client shall 選択したカードを強調表示し、選択値をサーバーへ送信する。
3. While ルームが投票公開状態であるとき, the Client shall 既に送信された投票値を参加者カードに表示する。

### Requirement 2: サーバー保持と配信

**Objective:** As the Server, I want 4 択シーケンスを保持し配信できるように, so that クライアント間で選択肢が共有される

#### Acceptance Criteria

1. The Server shall ルーム作成時に `sequence` フィールドで '4choice' を受け付け、ルームオブジェクトに保存する。
2. When 新しいユーザーがルームに参加したとき, the Server shall そのルームの `sequence` を参加者に含めた `joinedRoom` メッセージを送信する。
3. When ルーム作成者が '4choice' を選択してルームを作成したとき, the Server shall `roomCreated` メッセージに `sequence: "4choice"` を含めて返す。

### Requirement 3: メッセージプロトコルの互換性

**Objective:** As a Developer, I want 明示的なメッセージ仕様を保つ, so that 既存クライアントとの互換性を維持できる

#### Acceptance Criteria

1. Where the feature is included, the Server shall `roomCreated` / `joinedRoom` メッセージに `sequence` フィールドを含める（既存値と同様の型で文字列を返す）。
2. If クライアントが古い仕様で `sequence` を送らない場合, the Server shall デフォルト（例: 'fibonacci'）でルームを作成し、エラーを返さない。

### Requirement 4: 投票の挙動と公開

**Objective:** As a Participant, I want 4 択で投票できる, so that 投票と集計が通常の流れで行える

#### Acceptance Criteria

1. When ユーザーが A/B/C/D のいずれかに投票したとき, the Server shall そのユーザーの投票を `room.votes` に保存する（ユーザー ID → 値のマッピング）。
2. When ルームオーナーが投票を公開したとき, the Server shall 全参加者に `votesRevealed` メッセージで保存された投票値を送信する。

### Requirement 5: 検証とエラー処理

**Objective:** As a System, I want invalid な入力に対して堅牢であること, so that 不正データがシステムを壊さない

#### Acceptance Criteria

1. If クライアントが `vote` メッセージで許容されない値を送信した場合, the Server shall 対応するエラーメッセージ (`type: 'error'`) を送信し、未登録の値は保存しない。
2. When シーケンスとして '4choice' が設定されているルームに対して、クライアントが他のシーケンスの値を送信した場合, the Server shall その投票を拒否し、クライアントにエラーを通知する。

### Requirement 6: テスト可能性

**Objective:** As QA, I want 再現可能な検証手順があること, so that 実装が要件を満たすか確認できる

#### Acceptance Criteria

1. The system shall 次の手順で手動テスト可能である: ルームを作成して `sequence: '4choice'` を設定 → 別タブで参加 → 各参加者が A/B/C/D を選択 → オーナーが公開 → 全参加者に正しい投票結果が表示される。
2. The system shall 自動テストとして、`roomCreated` のレスポンスに `sequence` を含むこと、`vote` の不正値を拒否するユニットテストを用意する。
